# DBSCAN Clustering on SA-ConvLSTM Predictions

This script applies DBSCAN clustering to the predictions generated by the SA-ConvLSTM model for microplastics concentration forecasting.

## What it does

The script `dbscan_convlstm_clustering.py` performs the following:

1. **Loads the trained SA-ConvLSTM model** from the saved checkpoint
2. **Applies DBSCAN clustering** to forecast predictions
3. **Creates visualizations** showing:
   - Original prediction maps
   - Clustered regions with convex hulls
   - Noise points
4. **Generates an animated GIF** showing clustering evolution over time
5. **Saves detailed results** in JSON format

## Files Generated

When you run the script, it creates:

- `dbscan_convlstm_results/` - Main output directory
  - `forecast_predictions/` - Individual clustered forecast images
  - `dbscan_forecast_animation.gif` - Animated visualization
  - `forecast_clustering_results.json` - Detailed clustering results
  - `clustering_summary.json` - Summary report

## How to Use

### 1. Prerequisites

Make sure you have:
- A trained SA-ConvLSTM model (`sa_convlstm_forecast_model.pth`)
- Forecast results file (`sa_convlstm_forecast_results.json`)
- Required Python packages (PyTorch, scikit-learn, matplotlib, etc.)

### 2. Run the Script

```bash
# Activate your virtual environment
source venv/bin/activate

# Run the clustering script
python dbscan_convlstm_clustering.py
```

### 3. Customize Parameters

You can adjust the DBSCAN parameters in the script:

```python
# In the apply_dbscan_to_prediction function:
threshold=0.25,    # Concentration threshold for clustering
eps=4,             # DBSCAN epsilon parameter
min_samples=4      # Minimum samples per cluster
```

## Current Status

âœ… **Script is working correctly!**
- Successfully loads the SA-ConvLSTM model
- Processes 5-day forecast predictions
- Applies DBSCAN clustering to each prediction
- Generates visualizations and animations
- Saves all results

## Sample Output

The script successfully processed 5 forecast days:
- 2025-06-17: 1 cluster, 2 noise points
- 2025-06-18: 1 cluster, 0 noise points  
- 2025-06-19: 1 cluster, 0 noise points
- 2025-06-20: 1 cluster, 1 noise point
- 2025-06-21: 1 cluster, 3 noise points

## Next Steps

To use this with real predictions instead of simulated data:

1. **Modify the forecast generation** to load actual model outputs
2. **Replace simulated data** with real predictions from your trained model
3. **Adjust clustering parameters** based on your specific data characteristics
4. **Customize visualization parameters** as needed

## Technical Details

- **Model**: SA-ConvLSTM with self-attention
- **Input**: 64x64 Japan region microplastics concentration maps
- **Clustering**: DBSCAN algorithm with convex hull visualization
- **Output**: PNG images, animated GIF, JSON results
- **Device**: MPS (Apple Silicon GPU) / CUDA / CPU

## Files Location

The script is located in the `regional-lstm/` folder alongside the SA-ConvLSTM model files, ensuring it can find all required dependencies and model checkpoints. 